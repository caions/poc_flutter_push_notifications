<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Notifications Test</title>
</head>
<body>
    <h1>Teste de Push Notifications</h1>
    <button id="subscribeBtn">Inscrever-se para Notifica√ß√µes</button>
    <button id="notifyBtn">Enviar Notifica√ß√£o</button>

    <script>
        const publicVapidKey = 'BJsleUGk2gNZy5zdDGVIPiEElcupJrNOh7D3APd6RUeADFjkB9zTx4Bno6Us5jTvt-17Brc8_JZxtnxCYshsHtA';

        async function registerServiceWorker() {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('‚úÖ Service Worker registrado:', registration);

                    const subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
                    });

                    console.log('üìå Inscri√ß√£o de Push:', JSON.stringify(subscription));

                    await fetch('/subscribe', {
                        method: 'POST',
                        body: JSON.stringify(subscription),
                        headers: { 'Content-Type': 'application/json' }
                    });

                    alert('üéâ Inscri√ß√£o realizada com sucesso!');
                } catch (error) {
                    console.error('‚ùå Erro ao registrar Service Worker:', error);
                    alert('Erro ao tentar se inscrever. Verifique as permiss√µes.');
                }
            } else {
                alert('üö´ Seu navegador n√£o suporta notifica√ß√µes push.');
            }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            return new Uint8Array([...rawData].map(char => char.charCodeAt(0)));
        }

        document.getElementById('subscribeBtn').addEventListener('click', registerServiceWorker);

        document.getElementById('notifyBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/sendNotification', { method: 'POST' });
                console.log('‚úÖ Notifica√ß√£o enviada:', await response.json());
            } catch (error) {
                console.error('‚ùå Erro ao enviar notifica√ß√£o:', error);
            }
        });
    </script>
</body>
</html>
